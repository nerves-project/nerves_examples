# HelloSnmpAgent

Demonstrates a configuration for using the Nerves target as an SNMP agent.

Uses [elixir-snmp](https://github.com/jeanparpaillon/elixir-snmp) to handle the
SNMP integration. The (editable) sample .mib, MY_MIB.mib, provided by
Mark Carlin.

## Hardware

The example was developed with a Raspberry Pi 3 but any Nerves-supported
hardware should work.

## Erlang Configuration Files for SNMP
[Erlang Agent
Documentation](https://erlang.org/doc/apps/snmp/snmp_impl_example_agent.html#association-file)

## Host and Target Configurations

A number of SNMP-related files are created when the application is compiled.
These files need to be on your target in a place where your app can find them
and use them. Further, some of these files are generated by you host machine
when you run the app on host.

An example of such a file is mentioned in the [HelloSnmpManager README](https://github.com/nerves-project/nerves_examples/tree/main/hello_snmp_manager).
The SNMP application for example requires a read-write path for the database
file. Unlike some `conf` files, `database` files will be created on the `target`
if they do not exist. A `/tmp` folder is available for most build targets that
has read/write privileges for the Nerves application. See
`hello_snmp_agent/config/target.exs` to see how the app is configured to use
this folder.

You will need to run the app with `iex -S mix` on your `host` in order to generate
some SNMP files, then you will either need to scp them up to the expected
locations, or put them in `priv`, then `mix firmware`, `mix upload`, and `ssh`
to your `target` move the files. This will all be detailed below in the
`How to use the code in this repository` section.

Relevant configuration lines for this application may be found in:

**config/host.exs**
```
config :hello_snmp_agent, HelloSnmpAgent.Agent,
  versions: [:v1, :v2, :v3],
  port: "SNMP_PORT" |> System.get_env("161") |> String.to_integer(),
  transports: ["127.0.0.1"],
  security: [
    [user: "public", password: "password", access: :public],
    [user: "admin", password: "adminpassword", access: [:public, :secure]]
  ]
```

**config/target.exs**  
```
config :hello_snmp_agent, HelloSnmpAgent.Agent,
  db_dir: '/tmp/',
  dir: '/root/'
```

## SNMP Resources
[ERLANG Documentation - SNMP Users Guide](http://erlang.org/doc/apps/snmp/snmp_intro.html)  
[elixir-snmp](https://github.com/jeanparpaillon/elixir-snmp)


## How to use the code in this repository
1. `export WIFI_PSK="my psk"`
2. `export WIFI_SSID="my ssid"`\
The `REG_DOM` below is used in `hello_snmp_agent/config/target.exs` for
vintage_net config, see https://github.com/nerves-networking/vintage_net and/or
[ISO 3166-1 alpha-2](https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2):
3. `export REG_DOM="my country code"` ("US" for example)
4. `export MIX_TARGET="my target"`
5. `mix deps.get`\
Generate files we will need for SNMP, run the following command for the `host`:
6. `MIX_TARGET=host mix deps.get`
7. `iex -S mix`\
Test SNMP on the `host` by running `snmpwalk` (with your `IEx` session running)
from the command line:
8. `snmpwalk -c public localhost .1.3.6.1.3.17`\
  You should see:
    ```
    SNMPv2-SMI::experimental.17.1.0 = INTEGER: 1
    SNMPv2-SMI::experimental.17.2.0 = INTEGER: 123
    SNMPv2-SMI::experimental.17.2.0 = No more variables left in this MIB View (It is past the end of the MIB tree)
    ```
  If instead you see:
    ```
    SNMPv2-SMI::experimental.17 = No more variables left in this MIB View (It is past the end of the MIB tree)
    ```
  Just stop the `IEx` session, restart it and try again. May be an issue with
  compilation but that should fix it in any event.

Remember that you should have `WIFI_PSK`, `WIFI_SSID`, `REG_DOM`, and
`MIX_TARGET` (as your `target`, not `host`) set already. Copy generated files to
`hello_snmp_agent/priv` in step 9 below:\
9. `cp -r _build/dev/lib/hello_snmp_agent/priv/snmp/agent/conf/*.conf priv/.`\
10. Insert SD card into `host` machine and `mix firmware.burn`\
11. Insert SD card into your `target` device, power it on.\
We will now need to move the files that you copied to `/priv` on your `host` to
where the application expects them to be on the `target`. At least some of these
files are not `readonly` which is why we didn't just put them into
`/rootfs_overlay`, steps 11-12 move the files.\
12. `ssh nerves.local`\
13. `HelloSnmpAgent.copy_conf()`\
14. `ls "/root"`\
  Verify the following files exist:
    - `agent.conf`
    - `community.conf`
    - `context.conf`
    - `notify.conf`
    - `standard.conf`
    - `target_addr.conf`
    - `target_params.conf`
    - `usm.conf`
    - `vacm.conf`
  If they aren't there in `/root` now, just find them and move them to `/root`.
  `HelloSnmpAgent.copy_conf/0` was added as convenience for this `README` and it
  may not always work as expected (filepaths change, etc).
15. Optionally restart your application or your `target` device (works without a
restart), but if step 15 doesn't work for you try a restart.\
16. `snmpwalk -c public nerves.local .1.3.6.1.3.17`
  You should see:
    ```
    SNMPv2-SMI::experimental.17.1.0 = INTEGER: 1
    SNMPv2-SMI::experimental.17.2.0 = INTEGER: 123
    SNMPv2-SMI::experimental.17.2.0 = No more variables left in this MIB View (It is past the end of the MIB tree)
    ```\
17. In `lib/hello_snmp_agent/snmp/mib/my_mib.ex`, we defined
  `someObjectIFOutput` to be able to read and write pin 26. Our
  `hello_snmp_agent/mibs/MY-MIB.mib` said the `oid` (`SNMP` identifier) for this
  is `.1.3.6.1.3.17.1.0` and that valid values are `0` or `1`. So, ssh to your
  target and get the value for pin 26 (steps 17-19):\
18. `ssh nerves.local`\
19. ```
    {:ok, gpio} = Circuits.GPIO.open(26, :input)
    Circuits.GPIO.read(gpio)
    0
    ```
Now issue an snmpset command from any machine on your network that has snmp
tools installed:\
20. `snmpset -c public nerves.local .1.3.6.1.3.17.1.0 i 1`\
  You should see: `SNMPv2-SMI::experimental.17.1.0 = INTEGER: 1`\
21. Verify in your `target` device that the pin 26 was updated:
  ```
  Circuits.GPIO.read(gpio)
  1
  ```

Going forward, just remember that when you update SNMP-related files, you may
need to `cp -r _build/dev/lib/hello_snmp_agent/priv/snmp/agent/conf/*.conf priv/.`
again and move the files to the intended place on the `target` again.

## Learn More

* Official docs: https://hexdocs.pm/nerves/getting-started.html
* Official website: https://nerves-project.org/
* Discussion Slack elixir-lang #nerves ([Invite](https://elixir-slackin.herokuapp.com/))
* Source: https://github.com/nerves-project/nerves
